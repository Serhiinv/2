name: Tests with Allure Report (History)

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update Playwright to latest version
        run: npm install -D @playwright/test@latest playwright@latest allure-playwright

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install Allure commandline
        run: |
          curl -o allure-commandline.tgz -OL https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.25.0/allure-commandline-2.25.0.tgz
          tar -zxvf allure-commandline.tgz -C /tmp
          sudo mv /tmp/allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          rm allure-commandline.tgz

      - name: Run Playwright tests
        run: npx playwright test --project=chromium
        env:
          CI: true

      - name: Set Timestamped Report Directory
        run: |
          TS=$(date +'%Y%m%d-%H%M%S')
          echo "REPORT_DIR=allure-reports/$TS" >> $GITHUB_ENV

      - name: Generate Allure Report
        if: always()
        run: |
          mkdir -p "$REPORT_DIR"
          allure generate allure-results -o "$REPORT_DIR" --clean

      - name: Upload Allure Reports artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-reports
          path: allure-reports
          retention-days: 30

  deploy-report:
    needs: test
    if: always()
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Download Allure Reports artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-reports
          path: allure-reports

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Generate Allure Report Index
        if: always()
        run: |
          REPORTS_DIR="allure-reports"
          INDEX_FILE="$REPORTS_DIR/index.html"
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Allure Report History</title></head><body>' > $INDEX_FILE
          echo '<h1>Allure Report History</h1><ul>' >> $INDEX_FILE
          for d in $REPORTS_DIR/*/ ; do
            [ -d "$d" ] || continue
            ts=$(basename $d)
            echo "<li><a href=\"./$ts/index.html\">$ts</a></li>" >> $INDEX_FILE
          done
          echo '</ul></body></html>' >> $INDEX_FILE

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-reports

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4